generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(uuid())
  name      String
  email     String     @unique
  password  String
  role      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  auditLogs AuditLog[]

  @@map("users")
}

model AuditLog {
  id           String   @id @default(uuid())
  action       String
  category     String
  userId       String?
  entityType   String?
  entityId     String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  success      Boolean  @default(true)
  errorMessage String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([category])
  @@index([userId])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@index([success])
  @@map("audit_logs")
}

model BusinessCategory {
  id             String    @id @default(uuid())
  name           String    @unique
  weightageScore Float     @default(0.5)
  categoryType   String    @default("BUSINESS")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  comments       Comment[]
  companies      Company[]

  @@map("business_categories")
}

model Post {
  id                  String        @id @default(uuid())
  title               String
  description         String?
  standardTitle       String?
  standardDescription String?
  postType            String
  issuedBy            String
  issueDate           DateTime
  deadline            DateTime?
  language            String
  pdfBase64           String?
  extractedText       String?
  status              String        @default("ACTIVE")
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  comments            Comment[]
  draftChunks         DraftChunk[]
  summaries           PostSummary[]

  @@map("posts")
}

model Comment {
  id                 String           @id @default(uuid())
  postId             String
  postTitle          String?
  companyId          String?
  businessCategoryId String
  stakeholderName    String
  rawComment         String
  standardComment    String?
  language           String?
  sentiment          String?
  weightageScore     Float?
  summary            String?
  keywords           String[]
  wordCount          Int?
  sentimentScore     Float?
  status             String           @default("RAW")
  processingError    String?
  processingAttempts Int              @default(0)
  processedAt        DateTime?
  modelVersion       String?
  isFlagged          Boolean          @default(false)
  isSpam             Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  commentType        String?
  docUrl             String?
  commentVector      CommentVector?
  businessCategory   BusinessCategory @relation(fields: [businessCategoryId], references: [id])
  company            Company?         @relation(fields: [companyId], references: [id])
  post               Post             @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([status])
  @@index([createdAt])
  @@index([businessCategoryId])
  @@index([companyId])
  @@map("comments")
}

model Company {
  id                 String           @id @default(uuid())
  name               String           @unique
  uniNumber          String?
  state              String?
  businessCategoryId String
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  comments           Comment[]
  businessCategory   BusinessCategory @relation(fields: [businessCategoryId], references: [id])

  @@index([businessCategoryId])
  @@map("companies")
}

model PostSummary {
  id            String   @id @default(uuid())
  postId        String
  summaryText   String
  totalComments Int      @default(0)
  positiveCount Int      @default(0)
  negativeCount Int      @default(0)
  neutralCount  Int      @default(0)
  weightedScore Float?
  topKeywords   String[]
  createdAt     DateTime @default(now())
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([createdAt])
  @@map("post_summaries")
}

model ProcessingQueue {
  id          String   @id @default(uuid())
  commentId   String   @unique
  priority    Int      @default(1)
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  status      String   @default("PENDING")
  errorLog    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([priority])
  @@map("processing_queue")
}

model DraftChunk {
  id        String                @id @default(uuid())
  postId    String
  content   String
  embedding Unsupported("vector")
  createdAt DateTime              @default(now())
  post      Post                  @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([postId], map: "draft_chunks_postid_idx")
  @@map("draft_chunks")
}

model CommentVector {
  id        String                @id @default(uuid())
  commentId String                @unique
  embedding Unsupported("vector")
  createdAt DateTime              @default(now())
  comment   Comment               @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@map("comment_vectors")
}
